rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---
    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin (Safely handle missing user docs)
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/barangay_users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/barangay_users/$(request.auth.uid)).data.role == "admin";
    }

    // --- Users ---
    match /barangay_users/{userId} {
      allow read: if isAuthenticated();
      // Allow user to create their own profile, or Admin to create any
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Allow user to edit own profile, or Admin to edit any
      allow update, delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // --- Barangays (Public) ---
    match /tagum_barangays/{barangayId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // --- Jobs ---
    match /barangay_jobs/{jobId} {
      allow read: if true;
      allow create: if isAuthenticated();
      
      // Allow delete only by owner or admin
      allow delete: if isAuthenticated() && (resource.data.postedBy == request.auth.uid || isAdmin());
      
      // Allow update if:
      // 1. Owner or Admin (can change anything)
      // 2. OR Any authenticated user (ONLY if they are just adding themselves to 'applicants')
      allow update: if isAuthenticated() && (
        resource.data.postedBy == request.auth.uid || 
        isAdmin() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['applicants'])
      );
    }

    // --- Services ---
    match /barangay_services/{serviceId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.providerId == request.auth.uid || isAdmin());
    }

    // --- Rentals ---
    match /barangay_rentals/{rentalId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // --- Transactions ---
    match /barangay_transactions/{transactionId} {
      // Allow read/update if user is Initiator OR Target OR Admin
      allow read, update: if isAuthenticated() && 
        (resource.data.initiatedBy == request.auth.uid || 
         resource.data.targetUser == request.auth.uid || 
         isAdmin());
         
      // Allow create if user is the initiator
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.initiatedBy;
    }

    // --- Feedback ---
    match /barangay_feedback/{feedbackId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.reviewedBy;
      allow update, delete: if isAdmin();
    }

    // --- Reports ---
    match /barangay_reports/{reportId} {
      allow create: if isAuthenticated();
      allow read, update: if isAdmin();
    }

    // --- Notifications ---
    match /barangay_notifications/{notificationId} {
      allow create: if isAuthenticated(); // Allow system or other users to trigger notifications
      // [FIXED] Added delete permission
      allow read, update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }

    // --- Favorites ---
    match /barangay_favorites/{favoriteId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Note: Delete on create/delete might be tricky with request.resource, but keeping as is for now unless broken
      allow create, delete: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // --- App Config ---
    match /app_config/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
  }
}
